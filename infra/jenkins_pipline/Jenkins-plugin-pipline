pipeline {
    agent any
    
    environment {
        // GitHub ë¦¬í¬ì§€í† ë¦¬ ì„¤ì •
        GITHUB_CREDENTIALS_ID = 'github-token'
        GITHUB_REPO = 'https://github.com/FISA-PJ/SpringBackEnd.git'
        GITHUB_BRANCH = 'main'
        
        // Airflow ì„œë²„ ì„¤ì • (ì™„ì „ ë¶„ë¦¬)
        AIRFLOW_HOST_ID = 'airflow-host'           // ap.loclx.io
        AIRFLOW_USER_ID = 'airflow-user'           // ubuntu
        AIRFLOW_PORT_ID = 'airflow-port'           // 22223
        SSH_KEY_ID = 'airflow-ssh-key'             // Airflow ì„œë²„ SSH í‚¤
        
        // ë°°í¬ ê²½ë¡œ ì„¤ì •
        LOCAL_PLUGIN_DIR = 'plugins/'              // ë¡œì»¬ í”ŒëŸ¬ê·¸ì¸ ë””ë ‰í† ë¦¬
        REMOTE_PLUGIN_PATH_ID = 'airflow-plugins-path'  // ì›ê²© í”ŒëŸ¬ê·¸ì¸ ê²½ë¡œ
    }
    
    triggers {
        githubPush()  // GitHub push ì‹œ ìë™ íŠ¸ë¦¬ê±°
    }
    
    stages {
        stage('Checkout Plugins') {
            steps {
                script {
                    echo "Checking out plugins from GitHub..."
                    
                    // GitHubì—ì„œ í”ŒëŸ¬ê·¸ì¸ ì½”ë“œ ì²´í¬ì•„ì›ƒ
                    git branch: "${GITHUB_BRANCH}", 
                        url: "${GITHUB_REPO}",
                        credentialsId: "${GITHUB_CREDENTIALS_ID}"
                    
                    // í”ŒëŸ¬ê·¸ì¸ ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
                    sh """
                        if [ -d "${LOCAL_PLUGIN_DIR}" ]; then
                            echo "í”ŒëŸ¬ê·¸ì¸ ë””ë ‰í† ë¦¬ ë°œê²¬: ${LOCAL_PLUGIN_DIR}"
                            ls -la ${LOCAL_PLUGIN_DIR}
                        else
                            echo "âš ï¸  í”ŒëŸ¬ê·¸ì¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤: ${LOCAL_PLUGIN_DIR}"
                            mkdir -p ${LOCAL_PLUGIN_DIR}
                        fi
                    """
                }
            }
        }
        
        stage('Validate Plugin Files') {
            steps {
                script {
                    echo "í”ŒëŸ¬ê·¸ì¸ íŒŒì¼ ê²€ì¦ ì¤‘..."
                    
                    // Python íŒŒì¼ ë¬¸ë²• ê²€ì‚¬
                    sh """
                        # í”ŒëŸ¬ê·¸ì¸ íŒŒì¼ë“¤ì˜ Python ë¬¸ë²• ê²€ì‚¬
                        find ${LOCAL_PLUGIN_DIR} -name "*.py" -type f | while read file; do
                            echo "Checking syntax: \$file"
                            python3 -m py_compile "\$file" || echo "âš ï¸  Syntax error in \$file"
                        done
                        
                        # requirements.txt í™•ì¸ (ìˆëŠ” ê²½ìš°)
                        if [ -f "${LOCAL_PLUGIN_DIR}requirements.txt" ]; then
                            echo "Requirements file found:"
                            cat ${LOCAL_PLUGIN_DIR}requirements.txt
                        fi
                    """
                }
            }
        }
        
        stage('Deploy Plugins to Airflow Server') {
            steps {
                withCredentials([
                    string(credentialsId: "${AIRFLOW_HOST_ID}", variable: 'AIRFLOW_HOST'),
                    string(credentialsId: "${AIRFLOW_USER_ID}", variable: 'AIRFLOW_USER'),
                    string(credentialsId: "${AIRFLOW_PORT_ID}", variable: 'AIRFLOW_PORT'),
                    string(credentialsId: "${REMOTE_PLUGIN_PATH_ID}", variable: 'REMOTE_PLUGIN_PATH')
                ]) {
                    sshagent(credentials: ["${SSH_KEY_ID}"]) {
                        script {
                            echo "Deploying plugins to Airflow server: ${AIRFLOW_USER}@${AIRFLOW_HOST}:${AIRFLOW_PORT}"
                            echo "Target path: ${REMOTE_PLUGIN_PATH}"
                            
                            // ì¬ì‹œë„ ë¡œì§ì„ í¬í•¨í•œ ë°°í¬
                            def maxRetries = 3
                            def deploySuccess = false
                            
                            for (int i = 0; i < maxRetries && !deploySuccess; i++) {
                                try {
                                    echo "ë°°í¬ ì‹œë„ ${i + 1}/${maxRetries}..."
                                    
                                    timeout(time: 5, unit: 'MINUTES') {
                                        sh """
                                            # SSH ì—°ê²° í…ŒìŠ¤íŠ¸ (ë¶„ë¦¬ëœ ë³€ìˆ˜ ì‚¬ìš©)
                                            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -p \${AIRFLOW_PORT} \${AIRFLOW_USER}@\${AIRFLOW_HOST} 'echo "SSH ì—°ê²° ì„±ê³µ"'
                                            
                                            # ì›ê²© ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ëŠ” ê²½ìš°)
                                            ssh -o StrictHostKeyChecking=no -p \${AIRFLOW_PORT} \${AIRFLOW_USER}@\${AIRFLOW_HOST} 'mkdir -p \${REMOTE_PLUGIN_PATH}'
                                            
                                            # í”ŒëŸ¬ê·¸ì¸ íŒŒì¼ë“¤ì„ Airflow ì„œë²„ë¡œ ë³µì‚¬ (ë¶„ë¦¬ëœ ë³€ìˆ˜ ì‚¬ìš©)
                                            rsync -avz --delete \\
                                                -e 'ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -p \${AIRFLOW_PORT}' \\
                                                \${LOCAL_PLUGIN_DIR} \\
                                                \${AIRFLOW_USER}@\${AIRFLOW_HOST}:\${REMOTE_PLUGIN_PATH}/
                                            
                                            # ë°°í¬ ê²°ê³¼ í™•ì¸
                                            ssh -o StrictHostKeyChecking=no -p \${AIRFLOW_PORT} \${AIRFLOW_USER}@\${AIRFLOW_HOST} \\
                                                'ls -la \${REMOTE_PLUGIN_PATH} && echo "ë°°í¬ëœ í”ŒëŸ¬ê·¸ì¸ íŒŒì¼ ìˆ˜: \$(find \${REMOTE_PLUGIN_PATH} -name "*.py" | wc -l)"'
                                        """
                                    }
                                    
                                    deploySuccess = true
                                    echo "âœ… í”ŒëŸ¬ê·¸ì¸ ë°°í¬ ì„±ê³µ!"
                                    
                                } catch (Exception e) {
                                    echo "âŒ ë°°í¬ ì‹œë„ ${i + 1} ì‹¤íŒ¨: ${e.getMessage()}"
                                    if (i < maxRetries - 1) {
                                        echo "30ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„..."
                                        sleep(30)
                                    } else {
                                        error("í”ŒëŸ¬ê·¸ì¸ ë°°í¬ê°€ ${maxRetries}ë²ˆ ëª¨ë‘ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        
        stage('Install Plugin Dependencies') {
            steps {
                withCredentials([
                    string(credentialsId: "${AIRFLOW_HOST_ID}", variable: 'AIRFLOW_HOST'),
                    string(credentialsId: "${AIRFLOW_USER_ID}", variable: 'AIRFLOW_USER'),
                    string(credentialsId: "${AIRFLOW_PORT_ID}", variable: 'AIRFLOW_PORT'),
                    string(credentialsId: "${REMOTE_PLUGIN_PATH_ID}", variable: 'REMOTE_PLUGIN_PATH')
                ]) {
                    sshagent(credentials: ["${SSH_KEY_ID}"]) {
                        script {
                            echo "í”ŒëŸ¬ê·¸ì¸ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
                            
                            try {
                                timeout(time: 5, unit: 'MINUTES') {
                                    sh """
                                        ssh -o StrictHostKeyChecking=no -p \${AIRFLOW_PORT} \${AIRFLOW_USER}@\${AIRFLOW_HOST} '
                                            # requirements.txtê°€ ìˆëŠ” ê²½ìš° ì˜ì¡´ì„± ì„¤ì¹˜
                                            if [ -f "\${REMOTE_PLUGIN_PATH}/requirements.txt" ]; then
                                                echo "Installing plugin dependencies..."
                                                
                                                # Virtual environment í™œì„±í™” (ìˆëŠ” ê²½ìš°)
                                                # source /path/to/airflow/venv/bin/activate || true
                                                
                                                # ì˜ì¡´ì„± ì„¤ì¹˜
                                                pip install -r \${REMOTE_PLUGIN_PATH}/requirements.txt || echo "Dependency installation failed"
                                            else
                                                echo "No requirements.txt found, skipping dependency installation"
                                            fi
                                        '
                                    """
                                }
                            } catch (Exception e) {
                                echo "âš ï¸  ì˜ì¡´ì„± ì„¤ì¹˜ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ê³„ì†): ${e.getMessage()}"
                            }
                        }
                    }
                }
            }
        }
        
        stage('Restart Airflow (Optional)') {
            steps {
                withCredentials([
                    string(credentialsId: "${AIRFLOW_HOST_ID}", variable: 'AIRFLOW_HOST'),
                    string(credentialsId: "${AIRFLOW_USER_ID}", variable: 'AIRFLOW_USER'),
                    string(credentialsId: "${AIRFLOW_PORT_ID}", variable: 'AIRFLOW_PORT')
                ]) {
                    sshagent(credentials: ["${SSH_KEY_ID}"]) {
                        script {
                            echo "Airflow ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (ì„ íƒì‚¬í•­)..."
                            
                            try {
                                timeout(time: 2, unit: 'MINUTES') {
                                    sh """
                                        ssh -o StrictHostKeyChecking=no -p \${AIRFLOW_PORT} \${AIRFLOW_USER}@\${AIRFLOW_HOST} '
                                            # Docker Compose ì‚¬ìš© ì‹œ Airflow ì¬ì‹œì‘
                                            cd /mnt/d/team3/ml-backend-fastapi/airflow
                                            
                                            # Docker ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ (ì‹¤ì œ êµ¬ì„±ì— ë§ê²Œ ìˆ˜ì •)
                                            docker-compose restart webserver scheduler || echo "Docker restart failed"
                                            
                                            # ë˜ëŠ” systemd ì‚¬ìš© ì‹œ (ì£¼ì„ í•´ì œ)
                                            # sudo systemctl restart airflow-webserver || echo "Webserver restart failed"
                                            # sudo systemctl restart airflow-scheduler || echo "Scheduler restart failed"
                                            
                                            echo "Airflow ì¬ì‹œì‘ ì™„ë£Œ"
                                        '
                                    """
                                }
                            } catch (Exception e) {
                                echo "âš ï¸  Airflow ì¬ì‹œì‘ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ê³„ì†): ${e.getMessage()}"
                            }
                        }
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë¦¬
                sh 'ls -la'
                
                // ë¹Œë“œ ê²°ê³¼ ì•„ì¹´ì´ë¸Œ
                archiveArtifacts artifacts: "${LOCAL_PLUGIN_DIR}**/*", allowEmptyArchive: true
            }
        }
        
        success {
            echo """
            ğŸ‰ í”ŒëŸ¬ê·¸ì¸ ë°°í¬ íŒŒì´í”„ë¼ì¸ ì„±ê³µ!
            
            âœ… ë°°í¬ëœ ë””ë ‰í† ë¦¬: ${LOCAL_PLUGIN_DIR}
            âœ… ëŒ€ìƒ ì„œë²„: WSL2 Airflow Server
            âœ… ë°°í¬ ì‹œê°„: ${new Date()}
            
            í”ŒëŸ¬ê·¸ì¸ íŒŒì¼ë“¤ì´ WSL2 Airflow ì„œë²„ì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.
            """
        }
        
        failure {
            echo """
            âŒ í”ŒëŸ¬ê·¸ì¸ ë°°í¬ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨!
            
            ì‹¤íŒ¨í•œ ë¹Œë“œ: ${BUILD_NUMBER}
            ì‹¤íŒ¨ ì‹œê°„: ${new Date()}
            
            ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”.
            """
        }
    }
}