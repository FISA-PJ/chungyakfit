pipeline {
    agent any
    
    environment {
        // Docker ì´ë¯¸ì§€ ì„¤ì • (ML-Backend ë°©ì‹ê³¼ ë™ì¼)
        DOCKER_IMAGE = 'jaerimw/ai-agent-system'                 // Docker Hub ì €ì¥ì†Œëª…
        DOCKERHUB_CREDENTIALS_ID = 'docker-hub'                  // Docker Hub ìê²©ì¦ëª… ID
        
        // Kubernetes ì„¤ì • (ê¸°ì¡´ ML-Backend ì„¤ì • ì°¸ê³ )
        KUBECONFIG_CREDENTIALS_ID = 'kubeconfig'                 // Kubernetes config ìê²©ì¦ëª… ID
        NAMESPACE = 'ai-agent'                                   // AI Agent ì „ìš© ë„¤ì„ìŠ¤í˜ì´ìŠ¤
        DEPLOYMENT_NAME = 'ai-agent-system'                      // Kubernetes Deployment ì´ë¦„
        
        // Secret ê°’ë“¤ì„ Jenkins Credentialsì—ì„œ ê°€ì ¸ì˜¤ê¸°
        OPENAI_API_KEY_ID = 'openai-api-key'                     // OpenAI API Key
        DB_PASSWORD_ID = 'db-password'                           // DB ë¹„ë°€ë²ˆí˜¸
        ES_HOST_ID = 'elasticsearch-host'                        // Elasticsearch í˜¸ìŠ¤íŠ¸
        
        // GitHub ì„¤ì •
        GITHUB_CREDENTIALS_ID = 'github-token'                   // GitHub í† í°
        GITHUB_REPO = 'https://github.com/FISA-PJ/ai-agent-system.git'
        GITHUB_BRANCH = 'main'
        
        // ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì • (ML-Backendì™€ ìœ ì‚¬í•œ FastAPI ê°€ì •)
        CONTAINER_PORT = '8000'                                  // FastAPI ê¸°ë³¸ í¬íŠ¸
        SERVICE_PORT = '80'                                      // ì„œë¹„ìŠ¤ í¬íŠ¸
        
        // ë¹Œë“œ ì„¤ì •
        DOCKERFILE_PATH = 'Dockerfile'
        BUILD_CONTEXT = '.'
    }
    
    triggers {
        githubPush()  // GitHub webhook íŠ¸ë¦¬ê±°
    }
    
    stages {
        stage('Checkout Source Code') {
            steps {
                script {
                    echo "Checking out AI Agent System source code..."
                    
                    // GitHubì—ì„œ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
                    git branch: "${GITHUB_BRANCH}", 
                        url: "${GITHUB_REPO}",
                        credentialsId: "${GITHUB_CREDENTIALS_ID}"
                    
                    // ì†ŒìŠ¤ì½”ë“œ êµ¬ì¡° í™•ì¸
                    sh """
                        echo "=== AI Agent System í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¸ ==="
                        ls -la
                        
                        # Dockerfile ì¡´ì¬ í™•ì¸
                        if [ -f "${DOCKERFILE_PATH}" ]; then
                            echo "âœ… Dockerfile ë°œê²¬: ${DOCKERFILE_PATH}"
                        else
                            echo "âš ï¸  Dockerfileì´ ì—†ìŠµë‹ˆë‹¤: ${DOCKERFILE_PATH}"
                        fi
                        
                        # K8s ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í™•ì¸
                        if [ -d "k8s" ] || [ -d "kubernetes" ]; then
                            echo "âœ… Kubernetes manifests ë°œê²¬"
                            find . -name "*.yaml" -o -name "*.yml" | head -5
                        fi
                    """
                }
            }
        }
        

        
        stage('Build Docker Image') {
            steps {
                script {
                    echo "Building Docker image: ${DOCKER_IMAGE}:${BUILD_NUMBER}"
                    
                    sh """
                        echo "=== AI Agent System Docker ë¹Œë“œ ì‹œì‘ ==="
                        echo "Build context: ${BUILD_CONTEXT}"
                        echo "Dockerfile: ${DOCKERFILE_PATH}"
                        
                        # Docker ì´ë¯¸ì§€ ë¹Œë“œ
                        docker build -f ${DOCKERFILE_PATH} -t ${DOCKER_IMAGE}:${BUILD_NUMBER} ${BUILD_CONTEXT}
                        
                        # latest íƒœê·¸ë„ ìƒì„±
                        docker tag ${DOCKER_IMAGE}:${BUILD_NUMBER} ${DOCKER_IMAGE}:latest
                        
                        # ë¹Œë“œëœ ì´ë¯¸ì§€ í™•ì¸
                        docker images | grep ${DOCKER_IMAGE}
                        
                        # ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
                        echo "=== ë¹Œë“œëœ ì´ë¯¸ì§€ ì •ë³´ ==="
                        docker inspect ${DOCKER_IMAGE}:${BUILD_NUMBER} --format='{{.Size}}' | numfmt --to=iec || echo "Size check failed"
                    """
                }
            }
        }
        
        stage('Push to DockerHub') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: "${DOCKERHUB_CREDENTIALS_ID}",
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    script {
                        echo "Pushing Docker image to Docker Hub..."
                        
                        // Docker Hub ë¡œê·¸ì¸
                        sh 'echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin'
                        
                        // ì¬ì‹œë„ ë¡œì§ì„ í¬í•¨í•œ push
                        def maxRetries = 3
                        def pushSuccess = false
                        
                        for (int i = 0; i < maxRetries && !pushSuccess; i++) {
                            try {
                                echo "Docker push ì‹œë„ ${i + 1}/${maxRetries}..."
                                
                                // ë¹Œë“œ ë²ˆí˜¸ íƒœê·¸ push
                                timeout(time: 15, unit: 'MINUTES') {
                                    sh "docker push ${DOCKER_IMAGE}:${BUILD_NUMBER}"
                                }
                                
                                // latest íƒœê·¸ push
                                timeout(time: 15, unit: 'MINUTES') {
                                    sh "docker push ${DOCKER_IMAGE}:latest"
                                }
                                
                                pushSuccess = true
                                echo "âœ… Docker push ì„±ê³µ!"
                                
                            } catch (Exception e) {
                                echo "âŒ Push ì‹œë„ ${i + 1} ì‹¤íŒ¨: ${e.getMessage()}"
                                if (i < maxRetries - 1) {
                                    echo "30ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„..."
                                    sleep(30)
                                } else {
                                    error("Docker pushê°€ ${maxRetries}ë²ˆ ëª¨ë‘ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
                                }
                            }
                        }
                    }
                }
            }
        }
        
        stage('Update Kubernetes Manifests') {
            steps {
                script {
                    echo "Updating Kubernetes deployment manifests..."
                    
                    sh """
                        # k8s ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
                        if [ -d "k8s" ] || [ -d "kubernetes" ]; then
                            echo "âœ… Kubernetes manifests directory found"
                            
                            # deployment.yamlì—ì„œ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
                            find . -name "deployment.yaml" -o -name "*.yaml" | xargs grep -l "image:" | while read file; do
                                echo "Updating image tag in: \$file"
                                sed -i 's|image: ${DOCKER_IMAGE}:.*|image: ${DOCKER_IMAGE}:${BUILD_NUMBER}|g' "\$file"
                            done
                            
                        else
                            echo "âš ï¸ Kubernetes manifests directory not found"
                            echo "Creating AI Agent System K8s manifests based on ML-Backend structure..."
                            
                            mkdir -p k8s
                            
                            # Namespace ìƒì„±
                            cat > k8s/namespace.yaml << EOF
apiVersion: v1
kind: Namespace
metadata:
  name: ${NAMESPACE}
EOF

                            # ConfigMap ìƒì„± (ML-Backend êµ¬ì¡° ì°¸ê³ )
                            cat > k8s/configmap.yaml << EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: ai-agent-config
  namespace: ${NAMESPACE}
data:
  # AI Agent ì„¤ì •
  APP_ENV: "production"
  LOG_LEVEL: "INFO"
  PORT: "${CONTAINER_PORT}"
  PYTHONUNBUFFERED: "1"
  
  # OpenAI ì„¤ì • (API KeyëŠ” Secretì—ì„œ)
  OPENAI_MODEL: "gpt-4"
  OPENAI_MAX_TOKENS: "4000"
  
  # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (ML-Backendì™€ ë™ì¼, ë¹„ë°€ë²ˆí˜¸ëŠ” Secretì—ì„œ)
  DB_HOST: "database-1.c5mygaasq9hj.ap-northeast-2.rds.amazonaws.com"
  DB_PORT: "3306"
  DB_USER: "app_user"
  APP_DB: "app_db"
  
  # Elasticsearch ì„¤ì •ì€ Secretì—ì„œ ê°€ì ¸ì˜´
EOF

                            # Secret ìƒì„± (Jenkins Credentialsì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°)
                            cat > k8s/secret.yaml << EOF
apiVersion: v1
kind: Secret
metadata:
  name: ai-agent-secret
  namespace: ${NAMESPACE}
type: Opaque
stringData:
  # stringDataë¥¼ ì‚¬ìš©í•˜ë©´ base64 ì¸ì½”ë”© ìë™ ì²˜ë¦¬
  OPENAI_API_KEY: "\${OPENAI_API_KEY}"
  DB_PASSWORD: "\${DB_PASSWORD}"
EOF

                            # Deployment ìƒì„± (ML-Backend êµ¬ì¡° ê¸°ë°˜)
                            cat > k8s/deployment.yaml << EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${DEPLOYMENT_NAME}
  namespace: ${NAMESPACE}
  labels:
    app: ${DEPLOYMENT_NAME}
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ${DEPLOYMENT_NAME}
  template:
    metadata:
      labels:
        app: ${DEPLOYMENT_NAME}
    spec:
      containers:
      - name: ${DEPLOYMENT_NAME}
        image: ${DOCKER_IMAGE}:${BUILD_NUMBER}
        imagePullPolicy: IfNotPresent
        
        ports:
        - containerPort: ${CONTAINER_PORT}
          name: http
          
        # ConfigMapê³¼ Secretì—ì„œ í™˜ê²½ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸° (ML-Backend ë°©ì‹)
        envFrom:
        - configMapRef:
            name: ai-agent-config
        - secretRef:
            name: ai-agent-secret
            
        resources:
          requests:
            memory: "2Gi"
            cpu: "500m"
          limits:
            memory: "4Gi"
            cpu: "1000m"
            
        # í—¬ìŠ¤ì²´í¬ (FastAPI ê¸°ì¤€)
        readinessProbe:
          httpGet:
            path: /docs
            port: ${CONTAINER_PORT}
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          
        livenessProbe:
          httpGet:
            path: /health
            port: ${CONTAINER_PORT}
          initialDelaySeconds: 60
          periodSeconds: 20
          timeoutSeconds: 5
          failureThreshold: 3
EOF

                            # Service ìƒì„± (ML-Backend êµ¬ì¡° ê¸°ë°˜)
                            cat > k8s/service.yaml << EOF
apiVersion: v1
kind: Service
metadata:
  name: ${DEPLOYMENT_NAME}
  namespace: ${NAMESPACE}
  labels:
    app: ${DEPLOYMENT_NAME}
spec:
  type: ClusterIP
  selector:
    app: ${DEPLOYMENT_NAME}
  ports:
  - name: http
    port: ${SERVICE_PORT}
    targetPort: ${CONTAINER_PORT}
    protocol: TCP
EOF
                        fi
                        
                        # ìƒì„±ëœ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í™•ì¸
                        echo "=== ìƒì„±ëœ Kubernetes manifests ==="
                        find k8s/ -name "*.yaml" | while read file; do
                            echo "--- \$file ---"
                            head -10 "\$file"
                        done
                    """
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                withCredentials([
                    file(credentialsId: "${KUBECONFIG_CREDENTIALS_ID}", variable: 'KUBECONFIG'),
                    string(credentialsId: "${OPENAI_API_KEY_ID}", variable: 'OPENAI_API_KEY'),
                    string(credentialsId: "${DB_PASSWORD_ID}", variable: 'DB_PASSWORD'),
                    string(credentialsId: "${ES_HOST_ID}", variable: 'ES_HOST')
                ]) {
                    script {
                        echo "Deploying AI Agent System to Kubernetes cluster..."
                        
                        sh """
                            export KUBECONFIG=\$KUBECONFIG
                            
                            # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± (ì—†ëŠ” ê²½ìš°)
                            kubectl create namespace ${NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
                            
                            # Secretì— ì‹¤ì œ ê°’ ì£¼ì…í•˜ì—¬ ì¬ìƒì„±
                            if [ -f "k8s/secret.yaml" ]; then
                                echo "Creating Secret with actual values from Jenkins Credentials..."
                                
                                # kubectlì„ ì‚¬ìš©í•´ Secret ì§ì ‘ ìƒì„± (ì•ˆì „í•œ ë°©ë²•)
                                kubectl create secret generic ai-agent-secret \\
                                    --from-literal=OPENAI_API_KEY="\${OPENAI_API_KEY}" \\
                                    --from-literal=DB_PASSWORD="\${DB_PASSWORD}" \\
                                    --from-literal=ES_HOST="\${ES_HOST}" \\
                                    --namespace=${NAMESPACE} \\
                                    --dry-run=client -o yaml | kubectl apply -f -
                            fi
                            
                            # ConfigMap ë¨¼ì € ì ìš©
                            if [ -f "k8s/configmap.yaml" ]; then
                                kubectl apply -f k8s/configmap.yaml
                            fi
                            
                            # ë‚˜ë¨¸ì§€ Kubernetes manifests ì ìš© (Secret ì œì™¸)
                            find k8s/ -name "*.yaml" ! -name "secret.yaml" | xargs kubectl apply -f
                            
                            # ë°°í¬ ìƒíƒœ í™•ì¸
                            echo "=== AI Agent System ë°°í¬ ìƒíƒœ í™•ì¸ ==="
                            kubectl get all -n ${NAMESPACE}
                            
                            # ConfigMapê³¼ Secret í™•ì¸
                            kubectl get configmap -n ${NAMESPACE}
                            kubectl get secret -n ${NAMESPACE}
                            
                            # ë¡¤ì•„ì›ƒ ìƒíƒœ ëŒ€ê¸° (ML-Backendì™€ ë™ì¼í•œ ë°©ì‹)
                            kubectl rollout status deployment/${DEPLOYMENT_NAME} -n ${NAMESPACE} --timeout=600s
                        """
                    }
                }
            }
        }
        
        stage('Health Check & Validation') {
            steps {
                withCredentials([file(credentialsId: "${KUBECONFIG_CREDENTIALS_ID}", variable: 'KUBECONFIG')]) {
                    script {
                        echo "Performing AI Agent System health check and validation..."
                        
                        sh """
                            export KUBECONFIG=\$KUBECONFIG
                            
                            # Pod ìƒíƒœ ìƒì„¸ í™•ì¸
                            echo "=== AI Agent System Pod ìƒíƒœ ==="
                            kubectl get pods -l app=${DEPLOYMENT_NAME} -n ${NAMESPACE} -o wide
                            kubectl describe pods -l app=${DEPLOYMENT_NAME} -n ${NAMESPACE}
                            
                            # ì„œë¹„ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
                            echo "=== AI Agent System ì„œë¹„ìŠ¤ ì •ë³´ ==="
                            kubectl get svc ${DEPLOYMENT_NAME} -n ${NAMESPACE} -o wide || echo "Service not found"
                            
                            # ConfigMapê³¼ Secret ë§ˆìš´íŠ¸ í™•ì¸
                            echo "=== ConfigMapê³¼ Secret í™•ì¸ ==="
                            kubectl get configmap ai-agent-config -n ${NAMESPACE} || echo "ConfigMap not found"
                            kubectl get secret ai-agent-secret -n ${NAMESPACE} || echo "Secret not found"
                            
                            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸ (ìµœê·¼ 100ì¤„)
                            echo "=== AI Agent System ë¡œê·¸ (ìµœê·¼ 100ì¤„) ==="
                            kubectl logs -l app=${DEPLOYMENT_NAME} -n ${NAMESPACE} --tail=100 || echo "No logs available"
                            
                            # ì• í”Œë¦¬ì¼€ì´ì…˜ Health Check
                            echo "=== AI Agent System Health Check ==="
                            POD_NAME=\$(kubectl get pods -l app=${DEPLOYMENT_NAME} -n ${NAMESPACE} -o jsonpath='{.items[0].metadata.name}')
                            if [ ! -z "\$POD_NAME" ]; then
                                echo "Testing pod: \$POD_NAME"
                                kubectl exec \$POD_NAME -n ${NAMESPACE} -- curl -f http://localhost:${CONTAINER_PORT}/health || \\
                                kubectl exec \$POD_NAME -n ${NAMESPACE} -- curl -f http://localhost:${CONTAINER_PORT}/docs || \\
                                kubectl exec \$POD_NAME -n ${NAMESPACE} -- curl -f http://localhost:${CONTAINER_PORT}/ || \\
                                echo "Health check endpoints not available"
                            fi
                            
                            # ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ í™•ì¸
                            echo "=== ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ==="
                            kubectl top pods -n ${NAMESPACE} || echo "Metrics not available"
                        """
                    }
                }
            }
        }
        
        stage('Cleanup Local Images') {
            steps {
                script {
                    echo "Cleaning up local Docker images..."
                    sh """
                        # ë¡œì»¬ ì´ë¯¸ì§€ ì •ë¦¬ (ì—ëŸ¬ ë¬´ì‹œ)
                        docker rmi ${DOCKER_IMAGE}:${BUILD_NUMBER} || true
                        docker rmi ${DOCKER_IMAGE}:latest || true
                        
                        # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
                        docker image prune -f || true
                        
                        # ë‚¨ì€ ì´ë¯¸ì§€ í™•ì¸
                        echo "=== ë‚¨ì€ Docker ì´ë¯¸ì§€ ==="
                        docker images | head -10
                        
                        # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
                        echo "=== ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ==="
                        df -h
                    """
                }
            }
        }
    }
    
    post {
        always {
            script {
                // Docker ë¡œê·¸ì•„ì›ƒ
                sh 'docker logout || true'
                
                // ë¹Œë“œ ê²°ê³¼ ì•„ì¹´ì´ë¸Œ (K8s manifests í¬í•¨)
                archiveArtifacts artifacts: 'k8s/**/*.yaml, kubernetes/**/*.yaml', allowEmptyArchive: true
                
                // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë¦¬
                sh 'ls -la'
            }
        }
        
        success {
            echo """
            ğŸ‰ AI Agent System ë°°í¬ íŒŒì´í”„ë¼ì¸ ì„±ê³µ!
            
            âœ… ë¹Œë“œ ë²ˆí˜¸: ${BUILD_NUMBER}
            âœ… Docker ì´ë¯¸ì§€: ${DOCKER_IMAGE}:${BUILD_NUMBER}
            âœ… ë°°í¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤: ${NAMESPACE}
            âœ… ë°°í¬ ì‹œê°„: ${new Date()}
            âœ… GitHub ì €ì¥ì†Œ: ${GITHUB_REPO}
            âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ í¬íŠ¸: ${CONTAINER_PORT}
            
            AI Agent Systemì´ ì„±ê³µì ìœ¼ë¡œ ë¹Œë“œë˜ê³  Kubernetesì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!
            """
        }
        
        failure {
            echo """
            âŒ AI Agent System ë°°í¬ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨!
            
            ì‹¤íŒ¨í•œ ë¹Œë“œ: ${BUILD_NUMBER}
            ì‹¤íŒ¨ ì‹œê°„: ${new Date()}
            GitHub ì €ì¥ì†Œ: ${GITHUB_REPO}
            ë„¤ì„ìŠ¤í˜ì´ìŠ¤: ${NAMESPACE}
            
            ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”.
            kubectl logs -l app=${DEPLOYMENT_NAME} -n ${NAMESPACE}
            """
        }
        
        unstable {
            echo "âš ï¸ AI Agent System íŒŒì´í”„ë¼ì¸ì´ ë¶ˆì•ˆì •í•œ ìƒíƒœë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”."
        }
    }
}